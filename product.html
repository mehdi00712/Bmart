<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bmart â€” Product</title>
  <link rel="stylesheet" href="style.css" />
  <style>.muted{color:#9ca3af}</style>
</head>
<body>
<header class="nav">
  <div class="logo"><a href="index.html" style="color:white;text-decoration:none">Bmart</a></div>
  <nav style="display:flex;gap:12px;align-items:center">
    <a href="index.html">Home</a>
    <a href="cart.html">Cart</a>
    <a href="checkout.html">Checkout</a>
    <a href="login.html">Login</a>
    <a href="signup.html">Sign up</a>
  </nav>
</header>

<main class="container" id="app"></main>

<script type="module">
  function readQuery(k){ return new URL(location.href).searchParams.get(k); }
  function fmtCurrency(x){ return `Rs ${Number(x||0).toFixed(2)}`; }
  function showError(msg, details=''){
    const app = document.getElementById('app');
    app.innerHTML = `<div class="card" style="padding:12px;background:#24151a;border:1px solid #7f1d1d;color:#fecaca">
      <b>${msg}</b>${details?`<div class="muted" style="white-space:pre-wrap;margin-top:6px">${details}</div>`:''}
    </div>`;
  }

  const id = readQuery('id');
  const app = document.getElementById('app');
  if (!id) { showError('Missing product id in URL'); throw new Error('No id'); }

  const { db, doc, getDoc } = await import('./firebase.js');
  const { addToCart } = await import('./store.js');
  const { initReviews } = await import('./reviews.js');

  async function render(){
    const snap = await getDoc(doc(db, 'products', id)).catch(e => { showError('Could not load product', String(e)); throw e; });
    if (!snap.exists()) { showError('Product not found'); return; }
    const p = snap.data();
    const img0 = (p.images && p.images[0]) || 'https://via.placeholder.com/800x600?text=Product';

    app.innerHTML = `
      <div class="product">
        <img src="${img0}" alt="${p.title}">
        <div>
          <h1>${p.title || 'Untitled product'}</h1>
          <p class="price">${fmtCurrency(Number(p.price || 0))}</p>
          ${p.category ? `<div class="muted" style="margin-bottom:6px">${p.category}</div>` : ''}
          <p>${(p.description || '').toString().replace(/</g,'&lt;')}</p>
          <label>Qty <input type="number" id="qty" min="1" value="1" style="max-width:100px"></label>
          <div class="row" style="border:none;padding:0;gap:8px;margin-top:8px">
            <button id="add">Add to Cart</button>
            <a href="index.html" class="btn" style="text-decoration:none">Continue Shopping</a>
          </div>
        </div>
      </div>
      <section id="reviews" style="margin-top:24px"></section>
    `;

    document.getElementById('add').onclick = () => {
      const qty = Math.max(1, Number(document.getElementById('qty').value || '1'));
      addToCart({ productId:id, title:p.title||'Product', price:Number(p.price||0), qty, sellerUid:p.ownerUid, shopId:p.shopId });
      alert('Added to cart');
    };

    await initReviews(id); // shows form if signed in; else invites to login
  }
  render();
</script>
</body>
</html>
