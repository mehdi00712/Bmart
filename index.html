<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bmart</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="nav">
  <div class="logo"><a href="index.html" style="color:white;text-decoration:none">Bmart</a></div>
  <nav style="display:flex;gap:12px;align-items:center">
    <a href="index.html">Home</a>
    <a href="cart.html">Cart</a>
    <a href="checkout.html">Checkout</a>
    <a href="login.html">Seller Login</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="admin.html" id="adminLink">Admin</a>
  </nav>
</header>

<main class="container">
  <h1>Featured Products</h1>
  <div class="row" style="border:none;padding:0">
    <input id="q" placeholder="Search products..." style="max-width:360px">
    <div>Cart (<span id="cartCount">0</span>)</div>
  </div>
  <div id="grid" class="grid"></div>
</main>

<script type="module">
  import { db, collection, getDocs, registerFcmToken, auth } from './firebase.js';
  import { fmtCurrency } from './util.js';
  import { getCart } from './store.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // Optional: hide Admin link unless it's YOU
  const SUPER_ADMIN_UID = "REPLACE_WITH_YOUR_UID"; // <-- same UID as in admin.html
  const adminLink = document.getElementById('adminLink');
  onAuthStateChanged(auth, (u) => {
    if (!u || u.uid !== SUPER_ADMIN_UID) {
      if (adminLink) adminLink.style.display = 'none';
    }
  });

  // Cart count
  document.getElementById('cartCount').textContent =
    getCart().reduce((n, it) => n + it.qty, 0);

  // Optional web push token registration
  registerFcmToken().catch(()=>{});

  const grid = document.getElementById('grid');
  const qInput = document.getElementById('q');

  async function loadProducts(term = '') {
    const snap = await getDocs(collection(db, 'products'));
    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .filter(p => p.isActive !== false);

    const filtered = term
      ? items.filter(p => (p.title || '').toLowerCase().includes(term.toLowerCase()))
      : items;

    grid.innerHTML = filtered.map(p => `
      <a class="card" href="product.html?id=${p.id}">
        <img src="${(p.images && p.images[0]) || 'https://via.placeholder.com/600x400?text=Product'}" alt="${p.title}">
        <div class="p-2">
          <h3>${p.title}</h3>
          <p>${fmtCurrency(p.price)}</p>
        </div>
      </a>
    ).join('');
  }

  qInput.addEventListener('input', e => loadProducts(e.target.value));
  loadProducts();
</script>
</body>
</html>
